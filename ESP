local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local espStorage = {}

local function createOrUpdateESP(player)
	if player == LocalPlayer then return end

	-- 古いESPを削除
	if espStorage[player] and espStorage[player].Billboard then
		espStorage[player].Billboard:Destroy()
	end

	local function attachESP()
		local character = player.Character
		if not character then return end

		local head = character:FindFirstChild("Head")
		local humanoid = character:FindFirstChild("Humanoid")
		local hrp = character:FindFirstChild("HumanoidRootPart")
		if not (head and humanoid and hrp) then return end

		local level = "N/A"
		if player:FindFirstChild("Data") and player.Data:FindFirstChild("Level") then
			level = player.Data.Level.Value
		end

		local billboard = Instance.new("BillboardGui")
		billboard.Name = "BloxESP"
		billboard.Size = UDim2.new(0, 120, 0, 35)
		billboard.StudsOffset = Vector3.new(0, 3.5, 0)
		billboard.Adornee = head
		billboard.AlwaysOnTop = true
		billboard.Parent = character

		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, 0, 0.6, 0)
		nameLabel.Position = UDim2.new(0, 0, 0, 0)
		nameLabel.BackgroundTransparency = 1
		nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
		nameLabel.TextStrokeTransparency = 0
		nameLabel.Font = Enum.Font.GothamBlack
		nameLabel.TextScaled = true
		nameLabel.Text = string.format("%s [Lv.%s]", player.Name, level)
		nameLabel.Parent = billboard

		local hpLabel = Instance.new("TextLabel")
		hpLabel.Size = UDim2.new(1, 0, 0.4, 0)
		hpLabel.Position = UDim2.new(0, 0, 0.6, 0)
		hpLabel.BackgroundTransparency = 1
		hpLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
		hpLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
		hpLabel.TextStrokeTransparency = 0
		hpLabel.Font = Enum.Font.GothamBlack
		hpLabel.TextScaled = true
		hpLabel.Text = ""
		hpLabel.Parent = billboard

		-- 永続更新
		if espStorage[player] and espStorage[player].Connection then
			espStorage[player].Connection:Disconnect()
		end

		local connection = RunService.RenderStepped:Connect(function()
			if humanoid and humanoid.Health > 0 then
				hpLabel.Text = string.format("[%d/%d]", math.floor(humanoid.Health), math.floor(humanoid.MaxHealth))
			else
				hpLabel.Text = "[死亡]"
			end
		end)

		espStorage[player] = {
			Billboard = billboard,
			Connection = connection,
		}
	end

	-- キャラクターが存在していれば即ESPをつける
	if player.Character then
		attachESP()
	end

	-- リスポーン対応
	player.CharacterAdded:Connect(function()
		task.wait(1)
		attachESP()
	end)
end

-- 初期プレイヤー全員にESP
for _, player in pairs(Players:GetPlayers()) do
	createOrUpdateESP(player)
end

-- 新しく入ったプレイヤーにもESP
Players.PlayerAdded:Connect(function(player)
	createOrUpdateESP(player)
end)
